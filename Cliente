import socket
import threading
import re
from colorama import Fore, init

init(autoreset=True)

client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  # cria um socket TCP

try:
    client.connect(('127.0.0.1', 55555))  # tenta conectar o cliente ao servidor
except ConnectionRefusedError:
    print(Fore.RED + "‚ùå N√£o foi poss√≠vel conectar ao servidor.")
    exit()

running = True

def validar_usuario(nome):
    if not nome.strip():
        print(Fore.RED + "‚ùå O nome de usu√°rio n√£o pode estar vazio.")
        return False
    if len(nome) < 3:
        print(Fore.RED + "‚ùå O nome de usu√°rio √© muito curto (m√≠nimo 3 caracteres).")
        return False
    if len(nome) > 16:
        print(Fore.RED + "‚ùå O nome de usu√°rio √© muito longo (m√°ximo 16 caracteres).")
        return False
    if not re.match(r'^[A-Za-z0-9_]+$', nome):
        print(Fore.RED + "‚ùå O nome de usu√°rio cont√©m s√≠mbolos inv√°lidos. Use apenas letras, n√∫meros e _.")
        return False
    return True


def autenticar_usuario():
    while True:
        user = input("Digite seu usu√°rio: ")
        if not validar_usuario(user):
            continue

        client.send(user.encode('utf-8'))  # envia o nome
        resposta = client.recv(1024).decode('utf-8')  # recebe resposta do servidor

        if resposta.strip() == "OK":
            print(Fore.GREEN + "‚úÖ Usu√°rio aceito! Conectado ao chat.")
            return user
        else:
            print(Fore.RED + resposta.strip())


def receive():  # recebe mensagens do servidor
    global running
    while running:
        try:
            message = client.recv(1024).decode('utf-8')
            if not message:
                break
            if f">> {user} foi banido" in message.lower() or f">> {user} saiu do chat" in message.lower():
                continue

            # formata a sa√≠da com cores
            if "saiu do chat" in message.lower():
                print(Fore.RED + message)
            elif "banido" in message.lower() or "üö´" in message:
                print(Fore.RED + message)
            elif "aviso" in message.lower() or "‚ö†Ô∏è" in message:
                print(Fore.YELLOW + message)
            else:
                print(Fore.GREEN + message)
        except:
            print(Fore.RED + "Voc√™ foi desconectado do servidor.")
            client.close()
            running = False
            break


def write():  # l√™ do teclado e envia mensagens para o servidor
    global running
    while running:
        msg = input("")
        if msg.lower() == "/quit":
            client.send(f"<< {user} saiu do chat >>".encode('utf-8'))
            client.close()
            running = False
            break

        if not msg.strip():
            continue

        message = f"[{user}] {msg}"
        client.send(message.encode('utf-8'))


# Processo inicial de autentica√ß√£o
message = client.recv(1024).decode('utf-8')
if message == 'NICK':
    user = autenticar_usuario()
else:
    print(Fore.RED + "‚ùå Erro na comunica√ß√£o com o servidor.")
    client.close()
    exit()

# Inicia as threads
threading.Thread(target=receive, daemon=True).start()
threading.Thread(target=write, daemon=True).start()

# Mant√©m o programa ativo
while running:
    pass
