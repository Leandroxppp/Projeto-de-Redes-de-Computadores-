import socket
import threading
from colorama import Fore, init

init(autoreset=True)

nickname = input("Digite seu apelido: ")

client = socket.socket(socket.AF_INET, socket.SOCK_STREAM) #cria um socket TCP

try:
    client.connect(('127.0.0.1', 55555))#tenta conectar o cliente ao servidor
except ConnectionRefusedError:
    print(Fore.RED + "NÃ£o foi possÃ­vel conectar ao servidor.")
    exit()

running = True

def receive(): #recebe mensagens do servidor e imprime na tela
    global running
    while running:
        try:
            message = client.recv(1024).decode('utf-8') #recebe mensagem do servidor    
            if not message:
                break
            if message == 'NICK': 
                client.send(nickname.encode('utf-8')) #envia o apelido para o servidor
            else:
              
                if f">> {nickname} foi banido" in message.lower() or f">> {nickname} saiu do chat" in message.lower():
                    continue

                # formata a saÃ­da com cores
                if "saiu do chat" in message.lower():
                    print(Fore.RED + message)
                elif "banido" in message.lower() or "ğŸš«" in message:
                    print(Fore.RED + message)
                elif "aviso" in message.lower() or "âš ï¸" in message:
                    print(Fore.YELLOW + message)
                else:
                    print(Fore.GREEN + message)
        except:
            print(Fore.RED + "VocÃª foi desconectado do servidor.") #se o recv retornar vazio/erro, fecha o socket
            client.close()
            running = False
            break


def write(): #lÃª do teclado e envia mensagens para o servidor
    global running
    while running:
        msg = input("") #lÃª a mensagem do usuÃ¡rio
        if msg.lower() == "/quit":
            client.send(f"<< {nickname} saiu do chat >>".encode('utf-8'))
            client.close()
            running = False
            break #sai do loop e termina a thread se o usuÃ¡rio digitar /quit

        if not msg.strip(): #ignora mensagens vazias
            continue

        message = f"[{nickname}] {msg}" #formata a mensagem com o apelido naa frente
        client.send(message.encode('utf-8')) #envia a mensagem para o servidor

# Inicia as threads
threading.Thread(target=receive, daemon=True).start()
threading.Thread(target=write, daemon=True).start()

# MantÃ©m o programa ativo
while running:
    pass
